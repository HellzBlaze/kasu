<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KASU V13 </title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Palette */
            --primary: #6366f1;
            --primary-grad: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --bg: #f8fafc;
            --surface: #ffffff;
            --surface-glass: rgba(255, 255, 255, 0.95);
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --input-bg: #f1f5f9;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 24px;
            --shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg: #0b0f19;
            --surface: #151b2b;
            --surface-glass: rgba(21, 27, 43, 0.95);
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #2d3748;
            --input-bg: #1e293b;
            --shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; transition: background 0.3s; }

        /* --- UTILS --- */
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; }
        
        /* --- TOAST --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; pointer-events: none; }
        .toast {
            background: var(--surface); color: var(--text); padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 10px; font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; gap: 10px; animation: slideDown 0.3s ease; border: 1px solid var(--border); pointer-events: auto;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--primary); }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- AUTH --- */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-dots { font-size: 2rem; letter-spacing: 12px; margin: 30px 0; color: var(--primary); height: 40px; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .num-btn { width: 70px; height: 70px; border-radius: 50%; border: none; background: var(--surface); color: var(--text); font-size: 1.5rem; font-weight: 500; box-shadow: var(--shadow); cursor: pointer; transition: 0.1s; }
        .num-btn:active { transform: scale(0.95); background: var(--input-bg); }

        /* --- LAYOUT --- */
        #app-wrapper { display: none; height: 100%; overflow-y: auto; padding-bottom: 120px; padding-top: 10px; scroll-behavior: smooth; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        
        header { margin-bottom: 20px; }
        .greeting { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        .brand { font-size: 1.6rem; font-weight: 800; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- COMPONENTS --- */
        .card { background: var(--surface); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border); }

        /* Hero */
        .hero-section { text-align: center; padding: 10px 0 20px 0; animation: fadeIn 0.5s ease; }
        .hero-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 5px; }
        .hero-balance { font-size: 3.2rem; font-weight: 800; color: var(--text); letter-spacing: -1.5px; line-height: 1; }
        .hero-currency { font-size: 1.8rem; color: var(--text-muted); vertical-align: super; margin-right: 4px; }

        /* Filters */
        .filter-container { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .filter-container::-webkit-scrollbar { display: none; }
        .filter-chip { display: inline-block; padding: 8px 16px; border-radius: 20px; background: var(--input-bg); color: var(--text-muted); font-size: 0.85rem; font-weight: 600; margin-right: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .filter-chip.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); }
        .date-range-box { display: none; gap: 10px; margin-bottom: 15px; animation: fadeIn 0.3s; }
        .date-range-box.show { display: flex; }
        .date-input { flex: 1; padding: 10px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-family: 'Poppins'; }

        /* Inputs */
        input, select { width: 100%; padding: 18px; margin-bottom: 15px; border-radius: 18px; border: 2px solid transparent; background: var(--input-bg); color: var(--text); font-size: 1rem; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); background: var(--surface); }

        /* Buttons */
        .btn { width: 100%; padding: 18px; border: none; border-radius: 18px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-grad); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-ghost { background: transparent; color: var(--text-muted); width: auto; padding: 5px 10px; font-size: 0.9rem; }
        .btn-icon-only { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--input-bg); color: var(--text); border: none; cursor: pointer; transition: 0.2s; }
        .btn-icon-only:active { background: var(--primary); color: white; }

        /* Visual Category Grid */
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .cat-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; opacity: 0.7; transition: 0.2s; }
        .cat-item.selected { opacity: 1; transform: translateY(-2px); }
        .cat-icon-circle { width: 50px; height: 50px; border-radius: 18px; background: var(--input-bg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; border: 2px solid transparent; transition: 0.2s; }
        .cat-item.selected .cat-icon-circle { border-color: var(--primary); background: var(--surface); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .cat-label { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); }

        /* Emoji Picker Popup */
        .emoji-picker-container { display: none; position: absolute; bottom: 60px; left: 0; width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 10px; box-shadow: var(--shadow); z-index: 500; height: 200px; overflow-y: auto; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .emoji-picker-container.show { display: grid; }
        .emoji-btn-item { font-size: 1.4rem; background: var(--input-bg); border: none; padding: 8px; border-radius: 8px; cursor: pointer; transition: 0.1s; }
        .emoji-btn-item:active { transform: scale(0.9); background: var(--primary); }

        /* Lists */
        .date-header { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin: 20px 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); position: relative; }
        .list-item:last-child { border-bottom: none; }
        .icon-box { width: 44px; height: 44px; border-radius: 14px; background: var(--input-bg); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; }
        .timestamp { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

        /* Navigation */
        .tab-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 400px; background: var(--surface-glass); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 35px; display: flex; justify-content: space-around; padding: 15px 0; z-index: 100; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .tab-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; transition: 0.3s; padding: 5px; }
        .tab-icon { font-size: 1.6rem; transition: 0.3s; display: block; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active .tab-icon { transform: translateY(-5px); }
        .tab-add-btn { background: var(--primary-grad); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.5); margin-top: -40px; border: 6px solid var(--bg); transition: 0.2s; }
        .tab-add-btn:active { transform: scale(0.9); }

        /* Mode Toggle */
        .mode-toggle { display: flex; background: var(--input-bg); padding: 5px; border-radius: 20px; margin-bottom: 25px; }
        .mode-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-muted); border-radius: 15px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .mode-btn.active { background: var(--surface); color: var(--text); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* Progress */
        .progress-track { height: 8px; background: var(--input-bg); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--success); border-radius: 4px; }
        .progress-fill.red { background: var(--danger); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="auth-overlay">
        <div style="font-size:3rem; margin-bottom:10px;">ğŸ”’</div>
        <h2 style="font-size:1.5rem;">Welcome Back</h2>
        <div class="pin-dots" id="pinDisplay"></div>
        <div class="numpad">
            <button class="num-btn" onclick="inputPin(1)">1</button>
            <button class="num-btn" onclick="inputPin(2)">2</button>
            <button class="num-btn" onclick="inputPin(3)">3</button>
            <button class="num-btn" onclick="inputPin(4)">4</button>
            <button class="num-btn" onclick="inputPin(5)">5</button>
            <button class="num-btn" onclick="inputPin(6)">6</button>
            <button class="num-btn" onclick="inputPin(7)">7</button>
            <button class="num-btn" onclick="inputPin(8)">8</button>
            <button class="num-btn" onclick="inputPin(9)">9</button>
            <button class="num-btn" onclick="clearPin()" style="color:var(--danger)">âœ•</button>
            <button class="num-btn" onclick="inputPin(0)">0</button>
            <button class="num-btn" onclick="submitPin()" style="background:var(--primary); color:white;">â†’</button>
        </div>
    </div>

    <div id="app-wrapper">
        <div class="container">
            <header class="flex-between">
                <div>
                    <div class="greeting" id="greeting">Hello</div>
                    <div class="brand">KASU</div>
                </div>
                <button onclick="toggleTheme()" style="background:none; border:none; font-size:1.4rem; cursor:pointer; padding:5px;">ğŸŒ—</button>
            </header>

            <div id="tab-home" class="view">
                <div class="hero-section">
                    <div class="hero-label">Total Net Worth</div>
                    <div class="hero-balance"><span class="hero-currency">â‚¹</span><span id="totalBalance">0.00</span></div>
                </div>

                <div class="filter-container">
                    <div class="filter-chip active" onclick="applyFilter(this, 'all')">All</div>
                    <div class="filter-chip" onclick="applyFilter(this, 'today')">Today</div>
                    <div class="filter-chip" onclick="applyFilter(this, 'month')">Month</div>
                    <div class="filter-chip" onclick="applyFilter(this, 'year')">Year</div>
                    <div class="filter-chip" onclick="toggleCustomDate(this)">Custom</div>
                </div>

                <div id="customDateBox" class="date-range-box">
                    <input type="date" id="startDate" class="date-input" onchange="applyCustomFilter()">
                    <input type="date" id="endDate" class="date-input" onchange="applyCustomFilter()">
                </div>
                
                <div class="card">
                    <div class="flex-between"><h3 style="margin:0; color:var(--text);">Analytics</h3></div>
                    <div style="height: 200px; position: relative; margin-top:20px;">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>

                <div style="padding-bottom: 20px;">
                    <h3 style="color:var(--text); margin-bottom: 15px; padding-left: 5px;">Activity</h3>
                    <div id="recentList"></div>
                </div>
            </div>

            <div id="tab-plan" class="view" style="display:none;">
                
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <div class="flex-between"><h2>Recurring</h2><button class="btn-ghost" onclick="showRecurForm()">+ Rule</button></div>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Set repeating transactions.</p>
                    <div id="recurList"></div>
                    <button class="btn btn-ghost" onclick="processRecurring(true)" style="margin-top:10px; font-size:0.8rem;">â†» Check Now</button>
                    
                    <div id="recurForm" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                        <input type="text" id="recurDesc" placeholder="Name (e.g. Rent, Netflix)">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <input type="number" id="recurAmount" placeholder="Amount">
                            <select id="recurFreq" onchange="toggleRecurMode()">
                                <option value="monthly">Monthly</option>
                                <option value="weekly">Weekly</option>
                                <option value="yearly">Yearly</option>
                                <option value="date">Specific Date</option>
                            </select>
                        </div>
                        
                        <div id="recurDayInput">
                            <input type="number" id="recurDay" placeholder="Day of Month (1-31)" min="1" max="31">
                        </div>
                        <div id="recurDateBox" style="display:none;">
                            <label style="font-size:0.8rem; color:var(--text-muted);">Start / Specific Date:</label>
                            <input type="date" id="recurDateInput">
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <select id="recurType">
                                <option value="expense">Expense (-)</option>
                                <option value="income">Income (+)</option>
                            </select>
                            <select id="recurAcc"><option disabled selected>Select Wallet</option></select>
                        </div>
                        <button class="btn btn-primary" onclick="addRecur()">Set Rule</button>
                    </div>
                </div>

                <div class="card">
                    <div class="flex-between"><h2>Budgets</h2><button class="btn-ghost" onclick="showBudgetForm()">+ Add</button></div>
                    <div id="budgetList"></div>
                    <div id="budgetForm" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                        <select id="budgetCat"></select>
                        <input type="number" id="budgetLimit" placeholder="Monthly Limit (â‚¹)">
                        <button class="btn btn-primary" onclick="saveBudget()">Set Budget</button>
                    </div>
                </div>

                <div class="card">
                    <div class="flex-between"><h2>Goals</h2><button class="btn-ghost" onclick="showGoalForm()">+ New</button></div>
                    <div id="goalList"></div>
                    <div id="goalForm" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                        <input type="text" id="goalName" placeholder="Name">
                        <input type="number" id="goalTarget" placeholder="Target">
                        <button class="btn btn-primary" onclick="createGoal()">Create Goal</button>
                    </div>
                </div>

                <div class="card">
                    <div class="flex-between"><h2>Bills</h2><button class="btn-ghost" onclick="showBillForm()">+ Add</button></div>
                    <div id="billList"></div>
                    <div id="billForm" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                        <input type="text" id="billName" placeholder="Name">
                        <input type="number" id="billAmount" placeholder="Amount">
                        <button class="btn btn-primary" onclick="addBill()">Save Bill</button>
                    </div>
                </div>
            </div>

            <div id="tab-add" class="view" style="display:none;">
                <div class="card">
                    <div class="mode-toggle">
                        <button class="mode-btn active" onclick="setMode('trans')" id="mode-trans">Transaction</button>
                        <button class="mode-btn" onclick="setMode('transfer')" id="mode-transfer">Transfer</button>
                    </div>

                    <form onsubmit="handleSubmit(event)">
                        <div style="text-align:center; margin-bottom:10px;">
                            <label style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Amount</label>
                            <input type="number" id="amount" placeholder="0" style="font-size:3rem; text-align:center; font-weight:800; background:transparent; border:none; padding:10px; color:var(--text);" required>
                        </div>

                        <div id="field-trans">
                            <div style="margin-bottom:15px;">
                                <label style="font-size:0.8rem; color:var(--text-muted);">Date & Time</label>
                                <input type="datetime-local" id="transDate" style="padding:12px;">
                            </div>

                            <input type="text" id="desc" placeholder="Note">
                            <label style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px; display:block;">Category</label>
                            <div class="cat-grid" id="categoryGrid"></div>
                            <input type="hidden" id="selectedCategory" value="Food">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                                <select id="type" style="margin:0;"><option value="expense">Expense</option><option value="income">Income</option></select>
                                <select id="account" style="margin:0;" required><option disabled selected>Select Wallet</option></select>
                            </div>
                        </div>

                        <div id="field-transfer" style="display:none;">
                            <div style="background:var(--input-bg); padding:20px; border-radius:20px; text-align:center;">
                                <select id="fromAccount" style="margin-bottom:10px; background:var(--surface);"><option disabled selected>From Wallet</option></select>
                                <div style="font-size:1.5rem; color:var(--primary); margin: 5px 0;">â¬‡</div>
                                <select id="toAccount" style="margin-top:10px; background:var(--surface);"><option disabled selected>To Wallet</option></select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="margin-top:20px;">Confirm</button>
                    </form>
                </div>
            </div>

            <div id="tab-more" class="view" style="display:none;">
                <div class="card">
                    <h2>Wallets</h2>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Use â†‘ â†“ arrows to rearrange. Max 20 wallets.</p>
                    <div id="walletList"></div>
                    
                    <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                        <h3 style="font-size:0.9rem;">Add New Wallet</h3>
                        <input type="text" id="newWallet" placeholder="Wallet Name" style="margin-bottom:10px;">
                        
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <select id="walletType" onchange="toggleWalletType()">
                                <option value="standard">Standard Account</option>
                                <option value="limit">Monthly Limit / Allowance</option>
                            </select>
                        </div>
                        
                        <div id="limitOptions" style="display:none; gap:10px; margin-bottom:10px;">
                            <input type="number" id="limitAmount" placeholder="Limit Amount">
                            <input type="number" id="limitDay" placeholder="Reset Day (1-28)" min="1" max="28">
                        </div>

                        <button class="btn btn-primary" style="width:auto;" onclick="addWallet()">Add Wallet</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Custom Categories</h2>
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;" id="manageCatList"></div>
                    
                    <div style="position:relative; display:flex; gap:10px;">
                        <button id="emojiTrigger" onclick="toggleEmojiPicker()" class="btn" style="width:60px; font-size:1.5rem; padding:0; background:var(--input-bg); color:var(--text);">ğŸ˜€</button>
                        <input type="text" id="newCatInput" placeholder="Name (e.g. Gym)" style="margin:0; flex:1;">
                        <button class="btn btn-primary" style="width:auto;" onclick="addCategory()">Add</button>
                        
                        <div id="emojiPicker" class="emoji-picker-container">
                            </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Settings</h2>
                    <button class="btn" style="background:var(--input-bg); color:var(--text); margin-bottom:10px;" onclick="exportCSV()">ğŸ“Š Export CSV</button>
                    <button class="btn" style="background:var(--input-bg); color:var(--text); margin-bottom:10px;" onclick="exportData()">â¬‡ Backup JSON</button>
                    <button class="btn" style="background:var(--input-bg); color:var(--text); margin-bottom:10px;" onclick="document.getElementById('fileInput').click()">â¬† Restore JSON</button>
                    <input type="file" id="fileInput" style="display:none;" onchange="importData(this)" accept=".json">
                    <button class="btn" style="background:rgba(239, 68, 68, 0.1); color:var(--danger);" onclick="resetApp()">Reset App</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="tab-bar" id="navBar" style="display:none;">
        <button class="tab-btn active" onclick="switchTab('home')" id="btn-home"><div class="tab-icon">ğŸ </div></button>
        <button class="tab-btn" onclick="switchTab('plan')" id="btn-plan"><div class="tab-icon">ğŸ¯</div></button>
        <div style="position:relative;"><button class="tab-add-btn" onclick="switchTab('add')" id="btn-add">ï¼‹</button></div>
        <button class="tab-btn" onclick="switchTab('more')" id="btn-more"><div class="tab-icon">âš™ï¸</div></button>
    </nav>

    <script>
        // --- CONSTANTS ---
        const EMOJI_LIST = [
            'ğŸ•','ğŸ”','ğŸŸ','ğŸ¿','â˜•','ğŸº','ğŸ›’','ğŸ›ï¸','ğŸ‘”','ğŸ‘—','ğŸš•','ğŸšŒ','âœˆï¸','â›½',
            'ğŸ ','ğŸ’¡','âš¡','ğŸš¿','ğŸ“','ğŸ’»','ğŸ“±','ğŸ®','ğŸ¬','ğŸµ','ğŸ“š','ğŸ“','ğŸ’Š','ğŸ‹ï¸',
            'âš½','ğŸ¨','ğŸ¶','ğŸ','ğŸ’°','ğŸ¦','ğŸ’¸','ğŸ”§','ğŸ”¨','ğŸ§¹','ğŸ¼','ğŸ‘¶','ğŸ’¼','ğŸ‰',
            'â¤ï¸','ğŸ¥','ğŸ¦·','ğŸ‘“','ğŸ•°ï¸','ğŸ“…','ğŸ”’','ğŸ”‘','ğŸ³ï¸','ğŸ','âœ‚ï¸','ğŸ–Šï¸','ğŸ“','ğŸ“¦'
        ];

        // --- DATA STORE ---
        let data = { 
            accounts: { "Cash": 0, "Bank": 0 }, 
            accountOrder: ["Cash", "Bank"], 
            accountMeta: {}, 
            transactions: [], budgets: {}, goals: [], bills: [],
            categories: ["Food", "Groceries", "Transport", "Shopping", "Entertainment", "Bills", "Health", "Education", "Salary"],
            categoryIcons: { "Groceries": "ğŸ›’" },
            recurring: [] 
        };
        let currentPin = "";
        let storedPin = localStorage.getItem('kasu_pin');
        let chartInstance = null;
        let addMode = 'trans';
        let currentFilter = 'all';
        let selectedEmoji = "ğŸ˜€";

        // --- AUTH ---
        function inputPin(n) { if(currentPin.length<4) { currentPin+=n; updatePinUI(); } }
        function clearPin() { currentPin=""; updatePinUI(); }
        function updatePinUI() { document.getElementById('pinDisplay').innerText = "â€¢".repeat(currentPin.length); }
        function submitPin() {
            if(currentPin.length!==4) return;
            if(!storedPin) { localStorage.setItem('kasu_pin', currentPin); unlock(); showToast("PIN Set!", "success"); } 
            else if(currentPin === storedPin) { unlock(); } 
            else { showToast("Wrong PIN", "error"); clearPin(); }
        }
        function unlock() {
            document.getElementById('auth-overlay').style.opacity = '0';
            setTimeout(() => { document.getElementById('auth-overlay').style.display='none'; }, 300);
            document.getElementById('app-wrapper').style.display='block';
            document.getElementById('navBar').style.display='flex';
            loadData();
            setGreeting();
            processRecurring();
            checkAccountResets();
            
            // Set Default Date
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('transDate').value = now.toISOString().slice(0,16);
        }

        // --- CORE ---
        function loadData() {
            const saved = localStorage.getItem('kasu_data');
            if(saved) {
                const parsed = JSON.parse(saved);
                data = { ...data, ...parsed };
                if(!data.accountOrder || data.accountOrder.length === 0) data.accountOrder = Object.keys(data.accounts);
                if(!data.recurring) data.recurring = [];
                if(!data.categoryIcons) data.categoryIcons = { "Groceries": "ğŸ›’" };
                if(!data.accountMeta) data.accountMeta = {};
                // Ensure migration if transactions lack date
                data.transactions.forEach(t => { if(!t.date) t.date = t.id; }); 
            }
            if(localStorage.getItem('kasu_theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
            renderAll();
        }
        function saveData() { localStorage.setItem('kasu_data', JSON.stringify(data)); renderAll(); }
        function renderAll() { 
            const currentKeys = Object.keys(data.accounts);
            currentKeys.forEach(k => { if(!data.accountOrder.includes(k)) data.accountOrder.push(k); });
            data.accountOrder = data.accountOrder.filter(k => currentKeys.includes(k));
            renderHome(); renderWallets(); renderPlanning(); renderCategoryUI(); 
        }
        function showToast(msg, type='success') {
            const t = document.createElement('div'); t.className = `toast ${type}`;
            t.innerHTML = type==='success'?'âœ… '+msg : (type==='info'?'â„¹ï¸ '+msg:'âš ï¸ '+msg);
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        function setGreeting() {
            const h = new Date().getHours();
            const g = h < 12 ? "Good Morning" : h < 18 ? "Good Afternoon" : "Good Evening";
            document.getElementById('greeting').innerText = g;
        }

        // --- EMOJI PICKER ---
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            if(picker.style.display === 'grid') {
                picker.style.display = 'none';
            } else {
                picker.innerHTML = '';
                EMOJI_LIST.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.className = 'emoji-btn-item';
                    btn.innerText = emoji;
                    btn.onclick = () => selectNewEmoji(emoji);
                    picker.appendChild(btn);
                });
                picker.style.display = 'grid';
            }
        }

        function selectNewEmoji(emoji) {
            selectedEmoji = emoji;
            document.getElementById('emojiTrigger').innerText = emoji;
            document.getElementById('emojiPicker').style.display = 'none';
        }

        // --- ACCOUNT LIMITS ---
        function checkAccountResets() {
            const now = new Date();
            let changed = false;
            Object.keys(data.accounts).forEach(acc => {
                const meta = data.accountMeta?.[acc];
                if(meta && meta.type === 'limit') {
                    const last = new Date(meta.lastReset || 0);
                    const isNewMonth = (now.getMonth() !== last.getMonth()) || (now.getFullYear() !== last.getFullYear());
                    if (isNewMonth && now.getDate() >= meta.day) {
                        data.accounts[acc] = parseFloat(meta.limit);
                        meta.lastReset = now.getTime();
                        changed = true;
                        showToast(`Refreshed ${acc} to â‚¹${meta.limit}`, 'info');
                    }
                }
            });
            if(changed) saveData();
        }

        // --- RECURRING ---
        function toggleRecurMode() {
            const freq = document.getElementById('recurFreq').value;
            const dayInput = document.getElementById('recurDayInput');
            const dateInput = document.getElementById('recurDateBox');
            if (freq === 'monthly') { dayInput.style.display = 'block'; dateInput.style.display = 'none'; } 
            else { dayInput.style.display = 'none'; dateInput.style.display = 'block'; }
        }

        function processRecurring(manual = false) {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0]; 
            let changed = false;
            let count = 0;

            for (let i = data.recurring.length - 1; i >= 0; i--) {
                const r = data.recurring[i];
                let shouldRun = false;

                if (r.freq === 'date') {
                    if (todayStr >= r.nextRun) { shouldRun = true; data.recurring.splice(i, 1); }
                } else {
                    let nextRunDate = new Date(r.nextRun);
                    if (todayStr >= r.nextRun) {
                        shouldRun = true;
                        if(r.freq === 'daily') nextRunDate.setDate(nextRunDate.getDate() + 1);
                        else if(r.freq === 'weekly') nextRunDate.setDate(nextRunDate.getDate() + 7);
                        else if(r.freq === 'monthly') nextRunDate.setMonth(nextRunDate.getMonth() + 1);
                        else if(r.freq === 'yearly') nextRunDate.setFullYear(nextRunDate.getFullYear() + 1);
                        r.nextRun = nextRunDate.toISOString().split('T')[0];
                    }
                }

                if (shouldRun) {
                    const ts = Date.now();
                    data.transactions.unshift({ id: ts, date: ts, desc: "Auto: " + r.desc, amount: r.amount, type: r.type, category: "Bills", account: r.account });
                    if(r.type==='expense') data.accounts[r.account]-=r.amount; else data.accounts[r.account]+=r.amount;
                    changed = true; count++;
                }
            }
            if(changed) { saveData(); showToast(`Processed ${count} items`, "info"); } 
            else if (manual) { showToast("Nothing due today", "success"); }
        }

        // --- FILTER ---
        function applyFilter(el, type) {
            currentFilter = type;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('customDateBox').classList.remove('show');
            renderHome();
        }
        function toggleCustomDate(el) {
            currentFilter = 'custom';
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('customDateBox').classList.add('show');
        }
        function applyCustomFilter() { renderHome(); }
        function getFilteredTransactions() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            let filtered = data.transactions;
            
            // Filter using the .date property if available, fallback to .id
            const getDate = (t) => t.date || t.id;

            if (currentFilter === 'today') filtered = filtered.filter(t => getDate(t) >= startOfDay);
            else if (currentFilter === 'month') filtered = filtered.filter(t => getDate(t) >= now.getTime() - (30 * 86400000));
            else if (currentFilter === 'year') filtered = filtered.filter(t => getDate(t) >= now.getTime() - (365 * 86400000));
            else if (currentFilter === 'custom') {
                const s = document.getElementById('startDate').valueAsDate;
                const e = document.getElementById('endDate').valueAsDate;
                if(s && e) { e.setHours(23, 59, 59, 999); filtered = filtered.filter(t => getDate(t) >= s.getTime() && getDate(t) <= e.getTime()); }
            }
            return filtered;
        }

        // --- RENDERERS ---
        function renderHome() {
            const total = Object.values(data.accounts).reduce((a,b)=>a+b,0);
            document.getElementById('totalBalance').innerText = total.toLocaleString('en-IN', {minimumFractionDigits: 2});
            const filteredTx = getFilteredTransactions();
            const list = document.getElementById('recentList'); list.innerHTML = "";
            if(filteredTx.length===0) { list.innerHTML = "<p style='text-align:center;color:var(--text-muted);padding:20px;'>No transactions found.</p>"; renderChart([]); return; }

            // Sort by Date property
            filteredTx.sort((a,b) => (b.date || b.id) - (a.date || a.id));
            
            let lastDate = "";
            filteredTx.forEach(t => {
                const dateObj = new Date(t.date || t.id);
                const today = new Date();
                const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
                let dateStr = dateObj.toLocaleDateString();
                if(dateObj.toDateString() === today.toDateString()) dateStr = "Today";
                else if(dateObj.toDateString() === yesterday.toDateString()) dateStr = "Yesterday";
                else dateStr = dateObj.toLocaleDateString('en-US', {month:'short', day:'numeric'});

                if(dateStr !== lastDate) { list.innerHTML += `<div class="date-header">${dateStr}</div>`; lastDate = dateStr; }

                const timeStr = dateObj.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
                const isInc = t.type === 'income';
                const sign = isInc ? '+' : '-';
                const color = isInc ? 'var(--success)' : (t.type==='transfer'?'var(--text)':'var(--text)');
                const icon = t.type==='transfer'?'â†”':(isInc?'â†“':'â†‘');
                const catIcon = getCatIcon(t.category);

                list.innerHTML += `<div class="list-item"><div style="display:flex; align-items:center;"><div class="icon-box" style="font-size:1rem;">${t.type==='transfer'?icon:catIcon}</div><div><div style="font-weight:600; font-size:0.95rem;">${t.desc}</div><div class="timestamp">${timeStr} â€¢ ${t.category}</div></div></div><div style="text-align:right;"><div style="font-weight:600; color:${color};">${sign}â‚¹${t.amount}</div><button onclick="delTrans(${t.id})" style="border:none;background:none;color:var(--text-muted);opacity:0.5;padding:5px;">ğŸ—‘</button></div></div>`;
            });
            renderChart(filteredTx);
        }

        function renderChart(txList) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const cats = {};
            const sourceData = txList || data.transactions;
            sourceData.forEach(t => { if(t.type === 'expense') cats[t.category] = (cats[t.category]||0) + t.amount; });
            if(chartInstance) chartInstance.destroy();
            const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
            chartInstance = new Chart(ctx, {
                type: 'doughnut', data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: colors, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'right', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-muted'), font: {family: 'Poppins'} } } } }
            });
        }

        function renderWallets() {
            const list = document.getElementById('walletList'); list.innerHTML = "";
            const selects = [document.getElementById('account'), document.getElementById('fromAccount'), document.getElementById('toAccount'), document.getElementById('recurAcc')];
            selects.forEach(s => { if(s) s.innerHTML = "<option disabled selected>Select Wallet</option>"; });

            data.accountOrder.forEach(k => {
                if(!data.accounts.hasOwnProperty(k)) return; 
                const v = data.accounts[k];
                const meta = data.accountMeta?.[k];
                const isLimit = meta && meta.type === 'limit';
                const limitInfo = isLimit ? `<span style="font-size:0.7rem; color:var(--primary);">ğŸ”„ Limit â‚¹${meta.limit} (Day ${meta.day})</span>` : '';

                list.innerHTML += `
                    <div class="list-item">
                        <div style="display:flex;align-items:center;">
                            <div style="display:flex;flex-direction:column;margin-right:10px;">
                                <button onclick="moveWallet('${k}', 'up')" style="border:none;background:none;font-size:0.8rem;cursor:pointer;color:var(--text-muted);">â–²</button>
                                <button onclick="moveWallet('${k}', 'down')" style="border:none;background:none;font-size:0.8rem;cursor:pointer;color:var(--text-muted);">â–¼</button>
                            </div>
                            <div class="icon-box">ğŸ’³</div>
                            <div>
                                <div style="font-weight:600;">${k}</div>
                                <div style="font-size:0.85rem;color:var(--text-muted);">â‚¹${v.toFixed(2)}</div>
                                ${limitInfo}
                            </div>
                        </div>
                        <div><button class="btn-icon-only" style="display:inline-flex;" onclick="renameAcc('${k}')">âœ</button><button class="btn-icon-only" style="display:inline-flex;color:var(--danger);" onclick="delAcc('${k}')">âœ•</button></div>
                    </div>`;
                selects.forEach(s => { if(s) s.innerHTML += `<option value="${k}">${k}</option>`; });
            });
        }
        
        function moveWallet(name, dir) {
            const idx = data.accountOrder.indexOf(name);
            if(dir==='up' && idx>0) { [data.accountOrder[idx], data.accountOrder[idx-1]] = [data.accountOrder[idx-1], data.accountOrder[idx]]; }
            else if(dir==='down' && idx<data.accountOrder.length-1) { [data.accountOrder[idx], data.accountOrder[idx+1]] = [data.accountOrder[idx+1], data.accountOrder[idx]]; }
            saveData();
        }

        function renderPlanning() {
            const rList = document.getElementById('recurList'); rList.innerHTML="";
            if(data.recurring.length===0) rList.innerHTML = "<p style='text-align:center;color:var(--text-muted);'>No active rules.</p>";
            data.recurring.forEach((r, i) => {
                const nextDate = new Date(r.nextRun);
                const dateStr = nextDate.toLocaleDateString('en-US', {month:'short', day:'numeric'});
                const freqMap = {daily:'Daily', weekly:'Weekly', monthly:'Monthly', yearly:'Yearly', date:'One-Time'};
                rList.innerHTML += `
                    <div class="list-item">
                        <div>
                            <strong>${r.desc}</strong>
                            <div style="font-size:0.8rem;color:var(--text-muted);">${freqMap[r.freq]} â€¢ â‚¹${r.amount}</div>
                            <div style="font-size:0.75rem;color:var(--primary);font-weight:600;">Next: ${dateStr}</div>
                        </div>
                        <button class="btn-icon-only" style="color:var(--danger);width:30px;height:30px;" onclick="delRecur(${i})">âœ•</button>
                    </div>`;
            });
            const bList = document.getElementById('budgetList'); bList.innerHTML = "";
            const spent = {};
            data.transactions.forEach(t => { if(t.type==='expense') spent[t.category] = (spent[t.category]||0) + t.amount; });
            if(Object.keys(data.budgets).length === 0) bList.innerHTML = "<p style='text-align:center;color:var(--text-muted);'>No budgets.</p>";
            for(const [cat, limit] of Object.entries(data.budgets)) {
                const used = spent[cat] || 0; const pct = Math.min((used/limit)*100, 100); const isOver = used > limit;
                bList.innerHTML += `<div style="margin-bottom:15px;"><div class="flex-between" style="font-size:0.9rem;margin-bottom:5px;"><strong>${cat}</strong><span style="color:${isOver?'var(--danger)':'var(--text-muted)'}">â‚¹${used} / â‚¹${limit}</span></div><div class="progress-track"><div class="progress-fill ${isOver?'red':''}" style="width:${pct}%"></div></div></div>`;
            }
            const gList = document.getElementById('goalList'); gList.innerHTML = "";
            if(data.goals.length===0) gList.innerHTML = "<p style='text-align:center;color:var(--text-muted);'>No goals.</p>";
            data.goals.forEach(g => { const pct = Math.min((g.saved/g.target)*100, 100); gList.innerHTML += `<div style="background:var(--input-bg);padding:15px;border-radius:20px;margin-bottom:10px;"><div class="flex-between"><strong>${g.name}</strong><span style="font-size:0.85rem;color:var(--success);">â‚¹${g.saved} / â‚¹${g.target}</span></div><div class="progress-track" style="margin-bottom:10px;"><div class="progress-fill" style="width:${pct}%"></div></div><div class="flex-between"><button class="btn-ghost" style="color:var(--primary);padding:0;" onclick="addFunds(${g.id})">+ Add</button><button class="btn-ghost" style="color:var(--danger);padding:0;" onclick="delGoal(${g.id})">Del</button></div></div>`; });
            const billList = document.getElementById('billList'); billList.innerHTML = "";
            if(data.bills.length===0) billList.innerHTML = "<p style='text-align:center;color:var(--text-muted);'>No bills.</p>";
            data.bills.forEach(b => { billList.innerHTML += `<div class="list-item"><div><div style="font-weight:600;">${b.name}</div><div style="color:var(--text-muted);font-size:0.85rem;">â‚¹${b.amount}</div></div><div><button class="btn-primary" style="padding:8px 16px;width:auto;display:inline-block;font-size:0.8rem;" onclick="payBill('${b.name}', ${b.amount})">Pay</button><button class="btn-icon-only" style="display:inline-flex;margin-left:5px;width:30px;height:30px;color:var(--danger);" onclick="delBill(${b.id})">âœ•</button></div></div>`; });
        }

        function renderCategoryUI() {
            const grid = document.getElementById('categoryGrid'); grid.innerHTML = '';
            const currentSel = document.getElementById('selectedCategory').value;
            data.categories.forEach(c => {
                grid.innerHTML += `<div class="cat-item ${currentSel===c?'selected':''}" onclick="selectCategory('${c}')"><div class="cat-icon-circle">${getCatIcon(c)}</div><span class="cat-label">${c}</span></div>`;
            });
            const bSel = document.getElementById('budgetCat'); if(bSel) { bSel.innerHTML = ''; data.categories.forEach(c => bSel.innerHTML += `<option value="${c}">${c}</option>`); }
            const mList = document.getElementById('manageCatList'); if(mList) { mList.innerHTML = ''; data.categories.forEach(c => mList.innerHTML += `<span style="background:var(--input-bg); padding:6px 12px; border-radius:12px; font-size:0.85rem;">${getCatIcon(c)} ${c} <span onclick="delCat('${c}')" style="color:var(--danger); cursor:pointer; margin-left:5px;">Ã—</span></span>`); }
        }

        function selectCategory(c) { document.getElementById('selectedCategory').value = c; renderCategoryUI(); }
        
        function getCatIcon(c) { 
            if(data.categoryIcons && data.categoryIcons[c]) return data.categoryIcons[c];
            const map = { 'Food':'ğŸ”','Transport':'ğŸš•','Shopping':'ğŸ›ï¸','Entertainment':'ğŸ¬','Bills':'âš¡','Education':'ğŸ“š','Salary':'ğŸ’°','Health':'ğŸ’Š','Groceries':'ğŸ›’'}; 
            return map[c] || 'âšª'; 
        }

        // --- ACTIONS ---
        function setMode(m) { addMode = m; document.getElementById('mode-trans').className = m==='trans'?'mode-btn active':'mode-btn'; document.getElementById('mode-transfer').className = m==='transfer'?'mode-btn active':'mode-btn'; document.getElementById('field-trans').style.display = m==='trans'?'block':'none'; document.getElementById('field-transfer').style.display = m==='transfer'?'block':'none'; }
        
        function handleSubmit(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('amount').value);
            if(!amt) { showToast("Enter amount", "error"); return; }
            
            // Get date from picker, default to now if empty
            const dateVal = document.getElementById('transDate').value;
            const dateObj = dateVal ? new Date(dateVal) : new Date();
            const ts = dateObj.getTime();
            const createId = Date.now(); // Metadata stamp

            if(addMode === 'trans') {
                const desc = document.getElementById('desc').value || 'Expense';
                const cat = document.getElementById('selectedCategory').value;
                const type = document.getElementById('type').value;
                const acc = document.getElementById('account').value;
                if(!acc || acc === "Select Wallet") { showToast("Select a wallet", "error"); return; }

                if(type === 'expense') data.accounts[acc] -= amt; else data.accounts[acc] += amt;
                data.transactions.unshift({ id: createId, date: ts, desc, amount: amt, type, category: cat, account: acc });
            } else {
                const from = document.getElementById('fromAccount').value; const to = document.getElementById('toAccount').value;
                if(!from || !to || from === to) { showToast("Invalid accounts", "error"); return; }
                data.accounts[from] -= amt; data.accounts[to] += amt;
                data.transactions.unshift({ id: createId, date: ts, desc: `To ${to}`, amount: amt, type: 'transfer', category: 'Transfer', account: from });
            }
            saveData(); showToast("Saved!"); document.getElementById('amount').value=""; document.getElementById('desc').value=""; switchTab('home');
        }

        function delTrans(id) {
            if(confirm("Delete?")) {
                const t = data.transactions.find(x => x.id === id);
                if(t.type === 'income') data.accounts[t.account] -= t.amount; else if(t.type === 'expense') data.accounts[t.account] += t.amount; else if(t.type === 'transfer') data.accounts[t.account] += t.amount;
                data.transactions = data.transactions.filter(x => x.id !== id);
                saveData(); showToast("Deleted");
            }
        }

        // --- MANAGE ---
        function toggleWalletType() {
            const t = document.getElementById('walletType').value;
            const opts = document.getElementById('limitOptions');
            opts.style.display = t === 'limit' ? 'flex' : 'none';
        }

        function addWallet() { 
            if(Object.keys(data.accounts).length >= 20) { showToast("Max 20 wallets reached", "error"); return; }
            const n = document.getElementById('newWallet').value.trim();
            const type = document.getElementById('walletType').value;
            if(n && !data.accounts[n]) { 
                data.accounts[n] = 0; data.accountOrder.push(n); 
                if(type === 'limit') {
                    const l = document.getElementById('limitAmount').value;
                    const d = document.getElementById('limitDay').value;
                    if(l && d) { data.accountMeta[n] = { type: 'limit', limit: l, day: d, lastReset: 0 }; data.accounts[n] = parseFloat(l); }
                }
                saveData(); document.getElementById('newWallet').value=""; 
            } else { showToast("Invalid Name or Exists", "error"); }
        }

        function delAcc(n) { if(confirm("Delete?")) { delete data.accounts[n]; data.accountOrder = data.accountOrder.filter(x=>x!==n); delete data.accountMeta[n]; saveData(); } }
        function renameAcc(o) { const n=prompt("Rename:",o); if(n&&n!==o&&!data.accounts[n]) { data.accounts[n]=data.accounts[o]; delete data.accounts[o]; data.accountOrder[data.accountOrder.indexOf(o)] = n; data.transactions.forEach(t=>{if(t.account===o)t.account=n}); data.recurring.forEach(r=>{if(r.account===o)r.account=n}); if(data.accountMeta[o]) { data.accountMeta[n]=data.accountMeta[o]; delete data.accountMeta[o]; } saveData(); } }
        
        function addCategory() { 
            const n=document.getElementById('newCatInput').value; const icon=selectedEmoji; 
            if(n && !data.categories.includes(n)) { data.categories.push(n); data.categoryIcons[n] = icon; document.getElementById('newCatInput').value=""; saveData(); } 
        }
        function delCat(c) { if(confirm("Delete?")) { data.categories=data.categories.filter(x=>x!==c); delete data.categoryIcons[c]; saveData(); } }
        
        // Planning
        function showRecurForm() { document.getElementById('recurForm').style.display='block'; }
        function addRecur() { 
            const d=document.getElementById('recurDesc').value; const a=parseFloat(document.getElementById('recurAmount').value); 
            const freq=document.getElementById('recurFreq').value; 
            const start=document.getElementById('recurStartDate').value;
            const t=document.getElementById('recurType').value; const acc=document.getElementById('recurAcc').value;
            let nextRunVal = start;
            let dayVal = 1;
            if(freq === 'monthly') {
                dayVal = parseInt(document.getElementById('recurDay').value);
                const now = new Date();
                let runDate = new Date();
                runDate.setDate(dayVal);
                if(now.getDate() > dayVal) runDate.setMonth(runDate.getMonth()+1);
                nextRunVal = runDate.toISOString().split('T')[0];
            }
            if(d && a && nextRunVal && acc && acc !== "Select Wallet") { data.recurring.push({id:Date.now(), desc:d, amount:a, freq: freq, nextRun: nextRunVal, day: dayVal, type:t, account:acc}); saveData(); document.getElementById('recurForm').style.display='none'; } else { showToast("Check input", "error"); }
        }
        function delRecur(i) { data.recurring.splice(i,1); saveData(); }

        function showBudgetForm() { document.getElementById('budgetForm').style.display='block'; }
        function saveBudget() { const c=document.getElementById('budgetCat').value; const l=parseFloat(document.getElementById('budgetLimit').value); if(l){ data.budgets[c]=l; saveData(); document.getElementById('budgetForm').style.display='none'; } }
        function showGoalForm() { document.getElementById('goalForm').style.display='block'; }
        function createGoal() { const n=document.getElementById('goalName').value; const t=parseFloat(document.getElementById('goalTarget').value); if(n&&t){ data.goals.push({id:Date.now(),name:n,target:t,saved:0}); saveData(); document.getElementById('goalForm').style.display='none'; } }
        function addFunds(id) { const a=prompt("Amount?"); if(a){ data.goals.find(g=>g.id===id).saved+=parseFloat(a); saveData(); } }
        function delGoal(id) { data.goals=data.goals.filter(g=>g.id!==id); saveData(); }
        function showBillForm() { document.getElementById('billForm').style.display='block'; }
        function addBill() { const n=document.getElementById('billName').value; const a=parseFloat(document.getElementById('billAmount').value); if(n&&a){ data.bills.push({id:Date.now(),name:n,amount:a}); saveData(); document.getElementById('billForm').style.display='none'; } }
        function delBill(id) { data.bills=data.bills.filter(b=>b.id!==id); saveData(); }
        function payBill(n,a) { if(confirm("Pay "+n+"?")) { const acc=Object.keys(data.accounts)[0]; data.accounts[acc]-=a; data.transactions.unshift({id:Date.now(),desc:"Paid: "+n,amount:a,type:'expense',category:'Bills',account:acc}); saveData(); showToast("Paid"); } }

        // --- UTILS ---
        function switchTab(t) { document.querySelectorAll('.view').forEach(e => e.style.display='none'); document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active')); document.getElementById(`tab-${t}`).style.display='block'; if(t!=='add') document.getElementById(`btn-${t}`).classList.add('active'); renderAll(); }
        function toggleTheme() { const c = document.documentElement.getAttribute('data-theme'); const n = c==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme', n); localStorage.setItem('kasu_theme', n); renderChart(); }
        
        function exportCSV() { let csv = "Date,Desc,Cat,Type,Amt,Acc\n"; data.transactions.forEach(t => { csv += `${new Date(t.date||t.id).toLocaleDateString()},${t.desc},${t.category},${t.type},${t.amount},${t.account}\n`; }); const b = new Blob([csv], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='kasu.csv'; a.click(); }
        function exportData() { const b=new Blob([JSON.stringify(data)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='kasu_backup.json'; a.click(); }
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    data = {
                        accounts: imported.accounts || {},
                        accountOrder: imported.accountOrder || Object.keys(imported.accounts || {}),
                        accountMeta: imported.accountMeta || {},
                        transactions: imported.transactions || [],
                        budgets: imported.budgets || {},
                        goals: imported.goals || [],
                        bills: imported.bills || [],
                        categories: imported.categories || ["Food", "Transport", "Shopping", "Entertainment", "Bills", "Health", "Education", "Salary"],
                        categoryIcons: imported.categoryIcons || { "Groceries": "ğŸ›’" },
                        recurring: imported.recurring || []
                    };
                    saveData();
                    showToast("Restored Successfully!", "success");
                } catch (err) {
                    showToast("Error reading file", "error");
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function resetApp() { if(confirm("Reset everything?")) { localStorage.clear(); location.reload(); } }

        if(!storedPin) { document.getElementById('app-wrapper').style.display='none'; }
    </script>
</body>
</html>
