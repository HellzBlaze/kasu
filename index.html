<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasu â€“ Smart Banking & Finance Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <style>
        :root {
            --primary: #1a73e8;
            --success: #34a853;
            --danger: #ea4335;
            --warning: #f9ab00;
            --dark: #202124;
            --light: #f8f9fa;
            --bg: #ffffff;
            --card-bg: #ffffff;
            --text: #202124;
            --text-muted: #666;
            --border: #e0e0e0;
            --shadow: rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --primary: #4285f4;
            --success: #34a853;
            --danger: #ea4335;
            --warning: #f9ab00;
            --dark: #f8f9fa;
            --light: #202124;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #e8eaed;
            --text-muted: #9aa0a6;
            --border: #303030;
            --shadow: rgba(0,0,0,0.3);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            margin: 0;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .navbar { 
            background: var(--primary); 
            box-shadow: 0 2px 10px var(--shadow);
        }
        .navbar-brand { 
            font-weight: 700; 
            font-size: 1.5rem;
            color: white !important;
        }
        .nav-link { 
            color: rgba(255,255,255,0.9) !important; 
            font-weight: 500;
        }
        .nav-link.active { 
            color: white !important; 
            border-bottom: 2px solid white;
        }
        .card { 
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px; 
            box-shadow: 0 4px 20px var(--shadow);
            transition: all 0.3s ease;
        }
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 25px var(--shadow);
        }
        .balance-card { 
            background: linear-gradient(135deg, var(--success), #5bb974); 
            color: white; 
            text-align: center;
            padding: 1.5rem;
        }
        .balance-amount {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        .btn-primary { 
            background: var(--primary); 
            border: none; 
            border-radius: 12px;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
        }
        .btn-primary:hover { 
            background: #0d5bbd; 
            transform: translateY(-1px);
        }
        .btn-secondary { 
            background: var(--text-muted); 
            border: none; 
            border-radius: 12px;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            color: white;
        }
        .btn-secondary:hover { 
            background: #5f6368; 
            transform: translateY(-1px);
        }
        #authForm { 
            max-width: 420px; 
            margin: 4rem auto; 
            padding: 2.5rem; 
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px; 
            box-shadow: 0 10px 30px var(--shadow);
        }
        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .auth-header h1 {
            font-weight: 700;
            color: var(--text);
            font-size: 2.2rem;
        }
        .auth-header p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        .form-control, .form-select {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }
        .form-control:focus, .form-select:focus {
            background: var(--card-bg);
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(26,115,232,.25);
            color: var(--text);
        }
        .form-control::placeholder {
            color: var(--text-muted);
        }
        .hidden { display: none; }
        .section { margin-bottom: 2rem; }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-positive { color: var(--success); font-weight: 600; }
        .transaction-negative { color: var(--danger); font-weight: 600; }
        .category-badge {
            background: rgba(26,115,232,0.1);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .budget-progress {
            height: 8px;
            border-radius: 4px;
            background: var(--border);
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .budget-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.4s ease;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 3rem;
        }
        .kasu-logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #1a73e8, #34a853);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .export-btn {
            background: rgba(95,99,104,0.1);
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        .export-btn:hover {
            background: rgba(95,99,104,0.2);
            color: var(--text);
        }
        .export-btn svg {
            width: 18px;
            height: 18px;
        }
        .auth-toggle {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        .auth-toggle a {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
        }
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        .password-strength {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        .strength-weak { color: var(--danger); }
        .strength-medium { color: var(--warning); }
        .strength-strong { color: var(--success); }
        .table {
            color: var(--text);
        }
        .table-light {
            background: rgba(0,0,0,0.02);
        }
        [data-theme="dark"] .table-light {
            background: rgba(255,255,255,0.02);
        }
        .theme-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
        }
        .demo-btn {
            margin-top: 1rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.75rem;
            font-weight: 600;
            width: 100%;
        }
        .demo-btn:hover {
            background: #2d8a4a;
        }
    </style>
</head>
<body>

<!-- Auth Page -->
<div id="authPage" class="container">
    <div id="authForm">
        <div class="auth-header">
            <h1><span class="kasu-logo">Kasu</span></h1>
            <p id="authSubtitle">Sign in to your account</p>
        </div>

        <!-- Login Form -->
        <form id="loginFormElement" class="auth-form">
            <div class="mb-3">
                <label for="loginEmail" class="form-label fw-semibold">Email</label>
                <input type="email" class="form-control form-control-lg" id="loginEmail" placeholder="you@example.com" required>
            </div>
            <div class="mb-3">
                <label for="loginPassword" class="form-label fw-semibold">Password</label>
                <input type="password" class="form-control form-control-lg" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-lg">Sign In</button>
        </form>

        <!-- Signup Form -->
        <form id="signupFormElement" class="auth-form hidden">
            <div class="mb-3">
                <label for="signupName" class="form-label fw-semibold">Full Name</label>
                <input type="text" class="form-control form-control-lg" id="signupName" placeholder="John Doe" required>
            </div>
            <div class="mb-3">
                <label for="signupEmail" class="form-label fw-semibold">Email</label>
                <input type="email" class="form-control form-control-lg" id="signupEmail" placeholder="you@example.com" required>
            </div>
            <div class="mb-3">
                <label for="signupPassword" class="form-label fw-semibold">Password</label>
                <input type="password" class="form-control form-control-lg" id="signupPassword" placeholder="Create a strong password" required>
                <div id="passwordStrength" class="password-strength"></div>
            </div>
            <div class="mb-3">
                <label for="signupConfirm" class="form-label fw-semibold">Confirm Password</label>
                <input type="password" class="form-control form-control-lg" id="signupConfirm" placeholder="Repeat your password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-lg">Create Account</button>
        </form>

        <div class="auth-toggle">
            <span id="toggleText">Don't have an account? </span>
            <a href="#" id="toggleLink">Sign up</a>
        </div>

        <!-- Demo Button (shown on login) -->
        <button id="demoLoginBtn" class="demo-btn">Try Demo Account</button>

        <p class="text-center mt-4 text-muted small">
            Demo mode: All data is stored locally in your browser.
        </p>
    </div>
</div>

<!-- Main App (unchanged from previous) -->
<div id="app" class="hidden">
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#dashboard">
                <span class="kasu-logo">Kasu</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="#dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="#transactions">Transactions</a></li>
                    <li class="nav-item"><a class="nav-link" href="#budget">Budget</a></li>
                    <li class="nav-item"><a class="nav-link" href="#reports">Reports</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button id="themeToggle" class="theme-toggle" title="Toggle dark mode">
                            <span id="themeIcon">ðŸŒ™</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button id="exportAllBtn" class="export-btn me-2" title="Export all data">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export All
                        </button>
                    </li>
                    <li class="nav-item">
                        <button id="logout" class="btn btn-outline-light">Logout</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Dashboard -->
        <div id="dashboard" class="section">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card balance-card">
                        <p class="mb-1 opacity-75">Total Balance</p>
                        <h2 class="balance-amount" id="balance">$0.00</h2>
                        <p class="mb-0 small">Available for spending</p>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card h-100 p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-semibold mb-0">Recent Activity</h5>
                            <button id="exportTransactionsBtn" class="export-btn" title="Export transactions">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export
                            </button>
                        </div>
                        <div id="recentTransactions"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions -->
        <div id="transactions" class="section hidden">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0 fw-bold">Transactions</h3>
                <button id="exportTransactionsBtn2" class="export-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export CSV
                </button>
            </div>
            <div class="card p-4 mb-4">
                <h5 class="fw-semibold mb-3">Add New Transaction</h5>
                <form id="addTransactionForm" class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="description" placeholder="Description (e.g., Coffee)" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" step="0.01" class="form-control" id="amount" placeholder="0.00" required>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="type">
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="transactionCategory" required>
                            <option value="">Select Category</option>
                            <option value="Food">Food & Dining</option>
                            <option value="Transport">Transport</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Bills">Bills & Utilities</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Add Transaction</button>
                    </div>
                </form>
            </div>
            <div class="card p-4">
                <h5 class="fw-semibold mb-3">Transaction History</h5>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Budget -->
        <div id="budget" class="section hidden">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0 fw-bold">Budget Planner</h3>
                <button id="exportBudgetsBtn" class="export-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export Budgets
                </button>
            </div>
            <div class="card p-4 mb-4">
                <h5 class="fw-semibold mb-3">Set Monthly Budget</h5>
                <form id="setBudgetForm" class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <select class="form-select" id="budgetCategory">
                            <option value="Food">Food & Dining</option>
                            <option value="Transport">Transport</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Bills">Bills & Utilities</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" step="0.01" class="form-control" id="budgetAmount" placeholder="Budget amount" required>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Set Budget</button>
                    </div>
                </form>
            </div>
            <div class="card p-4">
                <h5 class="fw-semibold mb-3">Budget Overview</h5>
                <div id="budgetList"></div>
            </div>
        </div>

        <!-- Reports -->
        <div id="reports" class="section hidden">
            <h3 class="mb-4 fw-bold">Spending Insights</h3>
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-semibold mb-0">Spending by Category (This Month)</h5>
                    <button id="exportReportBtn" class="export-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export Report
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="spendingChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Kasu Â© 2025 â€“ Your money, beautifully tracked.</p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // === THEME SYSTEM ===
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const html = document.documentElement;

    // Load saved theme
    const savedTheme = localStorage.getItem('kasu_theme') || 'light';
    html.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    // Toggle theme
    themeToggle.addEventListener('click', () => {
        const current = html.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('kasu_theme', newTheme);
        updateThemeIcon(newTheme);
    });

    function updateThemeIcon(theme) {
        themeIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    }

    // === USER AUTHENTICATION ===
    const usersDB = JSON.parse(localStorage.getItem('kasu_users')) || {};
    let currentUser = null;
    let userData = { balance: 0, transactions: [], budgets: {} };

    // DOM Elements
    const authPage = document.getElementById('authPage');
    const app = document.getElementById('app');
    const loginForm = document.getElementById('loginFormElement');
    const signupForm = document.getElementById('signupFormElement');
    const toggleLink = document.getElementById('toggleLink');
    const toggleText = document.getElementById('toggleText');
    const authSubtitle = document.getElementById('authSubtitle');
    const demoBtn = document.getElementById('demoLoginBtn');

    // Toggle Login/Signup
    toggleLink.addEventListener('click', (e) => {
        e.preventDefault();
        const isLogin = loginForm.classList.contains('hidden');
        
        if (isLogin) {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            authSubtitle.textContent = 'Sign in to your account';
            toggleText.textContent = "Don't have an account? ";
            toggleLink.textContent = 'Sign up';
            demoBtn.classList.remove('hidden');
        } else {
            signupForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            authSubtitle.textContent = 'Create your Kasu account';
            toggleText.textContent = 'Already have an account? ';
            toggleLink.textContent = 'Sign in';
            demoBtn.classList.add('hidden');
        }
    });

    // Demo Login
    demoBtn.addEventListener('click', () => {
        const demoEmail = 'demo@kasu.app';
        if (!usersDB[demoEmail]) {
            usersDB[demoEmail] = {
                name: 'Demo User',
                password: 'demo123',
                createdAt: new Date().toISOString(),
                data: {
                    balance: 1000,
                    transactions: [
                        { date: 'Oct 27, 2025', desc: 'Welcome Bonus', amount: 1000, type: 'income', category: 'Income' }
                    ],
                    budgets: {}
                }
            };
            localStorage.setItem('kasu_users', JSON.stringify(usersDB));
        }
        autoLogin(demoEmail);
    });

    // Password Strength
    document.getElementById('signupPassword').addEventListener('input', function() {
        const password = this.value;
        const strengthEl = document.getElementById('passwordStrength');
        let strength = 0;

        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;
        if (password.match(/[^a-zA-Z0-9]/)) strength++;

        if (strength === 0) {
            strengthEl.textContent = '';
        } else if (strength <= 2) {
            strengthEl.textContent = 'Weak password';
            strengthEl.className = 'password-strength strength-weak';
        } else if (strength === 3) {
            strengthEl.textContent = 'Medium password';
            strengthEl.className = 'password-strength strength-medium';
        } else {
            strengthEl.textContent = 'Strong password';
            strengthEl.className = 'password-strength strength-strong';
        }
    });

    // === SIGN UP ===
    signupForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const name = document.getElementById('signupName').value.trim();
        const email = document.getElementById('signupEmail').value.trim().toLowerCase();
        const password = document.getElementById('signupPassword').value;
        const confirm = document.getElementById('signupConfirm').value;

        if (!name || !email || !password) {
            alert('Please fill in all fields');
            return;
        }
        if (password !== confirm) {
            alert('Passwords do not match');
            return;
        }
        if (password.length < 6) {
            alert('Password must be at least 6 characters');
            return;
        }
        if (usersDB[email]) {
            alert('An account with this email already exists');
            return;
        }

        usersDB[email] = {
            name,
            password,
            createdAt: new Date().toISOString(),
            data: {
                balance: 0,
                transactions: [],
                budgets: {}
            }
        };
        localStorage.setItem('kasu_users', JSON.stringify(usersDB));
        
        alert(`Welcome, ${name}! Your account has been created.`);
        autoLogin(email);
    });

    // === LOGIN ===
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;

        if (!usersDB[email]) {
            alert('No account found with this email. Try signing up or use the Demo button!');
            return;
        }
        if (usersDB[email].password !== password) {
            alert('Incorrect password');
            return;
        }

        autoLogin(email);
    });

    function autoLogin(email) {
        currentUser = email;
        localStorage.setItem('kasu_current_user', email);
        authPage.classList.add('hidden');
        app.classList.remove('hidden');
        loadUserData();
        showSection('dashboard');
    }

    // === LOGOUT ===
    document.getElementById('logout').addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem('kasu_current_user');
        app.classList.add('hidden');
        authPage.classList.remove('hidden');
        loginForm.reset();
        signupForm.reset();
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
        authSubtitle.textContent = 'Sign in to your account';
        toggleText.textContent = "Don't have an account? ";
        toggleLink.textContent = 'Sign up';
        demoBtn.classList.remove('hidden');
    });

    // === LOAD USER DATA ===
    function loadUserData() {
        if (!currentUser || !usersDB[currentUser]) return;
        userData = usersDB[currentUser].data;
        saveUserData();
        loadAllData();
    }

    function saveUserData() {
        if (currentUser) {
            usersDB[currentUser].data = userData;
            localStorage.setItem('kasu_users', JSON.stringify(usersDB));
        }
    }

    // Auto-login
    const savedUser = localStorage.getItem('kasu_current_user');
    if (savedUser && usersDB[savedUser]) {
        currentUser = savedUser;
        authPage.classList.add('hidden');
        app.classList.remove('hidden');
        loadUserData();
        showSection('dashboard');
    }

    // === APP LOGIC ===
    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const target = e.target.getAttribute('href').substring(1);
            showSection(target);
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            e.target.classList.add('active');
        });
    });

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
        
        if (sectionId === 'reports') loadChart();
        if (sectionId === 'budget') loadBudgetList();
        if (sectionId === 'dashboard') loadDashboard();
        if (sectionId === 'transactions') loadTransactionsTable();
    }

    // Add Transaction (Fixed: Added category select)
    document.getElementById('addTransactionForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const desc = document.getElementById('description').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const type = document.getElementById('type').value;
        const categorySelect = document.getElementById('transactionCategory');
        const category = type === 'income' ? 'Income' : (categorySelect.value || 'Other');
        const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

        if (!desc || isNaN(amount) || amount <= 0 || (type === 'expense' && !categorySelect.value)) {
            alert('Please fill all fields, including category for expenses.');
            return;
        }

        const transaction = { date, desc, amount, type, category };
        userData.transactions.unshift(transaction);

        if (type === 'income') {
            userData.balance += amount;
        } else {
            userData.balance -= amount;
        }

        saveUserData();
        loadAllData();
        e.target.reset();
        categorySelect.value = ''; // Reset category
        showSection('transactions');
    });

    // Set Budget
    document.getElementById('setBudgetForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const cat = document.getElementById('budgetCategory').value;
        const amt = parseFloat(document.getElementById('budgetAmount').value);
        if (isNaN(amt) || amt <= 0) {
            alert('Please enter a valid budget amount.');
            return;
        }

        userData.budgets[cat] = amt;
        saveUserData();
        loadBudgetList();
        e.target.reset();
    });

    // Load Functions
    function loadDashboard() {
        document.getElementById('balance').textContent = `$${userData.balance.toFixed(2)}`;
        const recentList = document.getElementById('recentTransactions');
        recentList.innerHTML = '';
        const recent = userData.transactions.slice(0, 5);
        
        if (recent.length === 0) {
            recentList.innerHTML = '<p class="text-muted">No transactions yet. Add one!</p>';
            return;
        }

        recent.forEach(t => {
            const div = document.createElement('div');
            div.className = 'transaction-item';
            div.innerHTML = `
                <div>
                    <div class="fw-medium">${t.desc}</div>
                    <div class="text-muted small">${t.date} â€¢ <span class="category-badge">${t.category}</span></div>
                </div>
                <div class="${t.type === 'income' ? 'transaction-positive' : 'transaction-negative'}">
                    ${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}
                </div>
            `;
            recentList.appendChild(div);
        });
    }

    function loadTransactionsTable() {
        const tbody = document.getElementById('transactionTable');
        tbody.innerHTML = '';
        if (userData.transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No transactions recorded</td></tr>';
            return;
        }
        userData.transactions.forEach(t => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${t.date}</td>
                <td>${t.desc}</td>
                <td><span class="category-badge">${t.category}</span></td>
                <td class="text-end fw-semibold ${t.type === 'income' ? 'text-success' : 'text-danger'}">
                    ${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function loadBudgetList() {
        const container = document.getElementById('budgetList');
        container.innerHTML = '';
        const categories = ['Food', 'Transport', 'Entertainment', 'Shopping', 'Bills', 'Other'];
        let hasBudgets = false;

        categories.forEach(cat => {
            if (userData.budgets[cat]) {
                hasBudgets = true;
                const spent = userData.transactions
                    .filter(t => t.type === 'expense' && t.category === cat)
                    .reduce((sum, t) => sum + t.amount, 0);
                const budget = userData.budgets[cat];
                const remaining = budget - spent;
                const percent = Math.min((spent / budget) * 100, 100);
                const isOver = remaining < 0;

                const item = document.createElement('div');
                item.className = 'mb-4';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="fw-semibold">${cat}</div>
                            <div class="small text-muted">$${spent.toFixed(2)} of $${budget.toFixed(2)}</div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold ${isOver ? 'text-danger' : remaining < budget * 0.2 ? 'text-warning' : 'text-success'}">
                                $${Math.abs(remaining).toFixed(2)} ${isOver ? 'over' : 'left'}
                            </div>
                        </div>
                    </div>
                    <div class="budget-progress">
                        <div class="budget-fill" style="width: ${percent}%; background: ${isOver ? '#ea4335' : percent > 80 ? '#f9ab00' : '#1a73e8'}"></div>
                    </div>
                `;
                container.appendChild(item);
            }
        });

        if (!hasBudgets) {
            container.innerHTML = '<p class="text-muted">Set budgets to start tracking your spending goals.</p>';
        }
    }

    let chartInstance = null;
    function loadChart() {
        const ctx = document.getElementById('spendingChart').getContext('2d');
        const categories = {};
        userData.transactions
            .filter(t => t.type === 'expense')
            .forEach(t => {
                categories[t.category] = (categories[t.category] || 0) + t.amount;
            });

        const labels = Object.keys(categories);
        const data = Object.values(categories);

        if (chartInstance) chartInstance.destroy();

        const isDark = html.getAttribute('data-theme') === 'dark';
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels.length ? labels : ['No expenses'],
                datasets: [{
                    data: data.length ? data : [1],
                    backgroundColor: [
                        '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', 
                        '#9966ff', '#ff9f40', '#c9cbcf'
                    ],
                    borderWidth: 3,
                    borderColor: isDark ? '#1e1e1e' : '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: { color: isDark ? '#e8eaed' : '#202124' }
                    },
                    tooltip: {
                        callbacks: {
                            label: context => {
                                if (!data.length) return '';
                                const value = context.parsed;
                                const total = data.reduce((a,b) => a+b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return ` $${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function loadAllData() {
        loadDashboard();
        loadTransactionsTable();
        loadBudgetList();
    }

    // === EXPORT FUNCTIONS ===
    function exportToCSV(filename, rows) {
        const processRow = (row) => {
            return row.map(cell => {
                cell = cell.toString();
                if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                    cell = '"' + cell.replace(/"/g, '""') + '"';
                }
                return cell;
            }).join(',');
        };

        const csvContent = rows.map(processRow).join('\n');
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportTransactions() {
        if (userData.transactions.length === 0) { alert('No transactions!'); return; }
        const headers = ['Date', 'Description', 'Category', 'Type', 'Amount'];
        const rows = userData.transactions.map(t => [
            t.date, t.desc, t.category,
            t.type.charAt(0).toUpperCase() + t.type.slice(1),
            t.type === 'income' ? t.amount : -t.amount
        ]);
        exportToCSV(`kasu_transactions_${new Date().toISOString().split('T')[0]}.csv`, [headers, ...rows]);
    }

    function exportBudgets() {
        const active = Object.entries(userData.budgets);
        if (active.length === 0) { alert('No budgets!'); return; }
        const headers = ['Category', 'Budget', 'Spent', 'Remaining'];
        const rows = active.map(([cat, budget]) => {
            const spent = userData.transactions.filter(t => t.type === 'expense' && t.category === cat).reduce((s, t) => s + t.amount, 0);
            return [cat, budget, spent, budget - spent];
        });
        exportToCSV(`kasu_budgets_${new Date().toISOString().split('T')[0]}.csv`, [headers, ...rows]);
    }

    function exportReport() {
        const cats = {};
        userData.transactions.filter(t => t.type === 'expense').forEach(t => {
            cats[t.category] = (cats[t.category] || 0) + t.amount;
        });
        const data = Object.entries(cats);
        if (data.length === 0) { alert('No expenses!'); return; }
        const headers = ['Category', 'Total Spent'];
        exportToCSV(`kasu_report_${new Date().toISOString().split('T')[0]}.csv`, [headers, ...data]);
    }

    function exportAllData() {
        const backup = {
            user: currentUser,
            balance: userData.balance,
            transactions: userData.transactions,
            budgets: userData.budgets,
            exportedAt: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.href = url;
        link.download = `kasu_backup_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
    }

    // Export buttons
    document.getElementById('exportTransactionsBtn').addEventListener('click', exportTransactions);
    document.getElementById('exportTransactionsBtn2').addEventListener('click', exportTransactions);
    document.getElementById('exportBudgetsBtn').addEventListener('click', exportBudgets);
    document.getElementById('exportReportBtn').addEventListener('click', exportReport);
    document.getElementById('exportAllBtn').addEventListener('click', exportAllData);

    // Initial active tab
    if (document.querySelector('#dashboard a')) {
        document.querySelector('#dashboard a').classList.add('active');
    }
</script>
</body>
</html>
